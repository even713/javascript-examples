<html ng-app="showcase.angularWay.withOptions">
<link rel="stylesheet" href="../../vendor/angular-plugin/angular-datatables.css">
<link rel="stylesheet" href="../../vendor/datatable/jquery.dataTables.min.css">
<link rel="stylesheet" href="../../vendor/datatable/dataTables.responsive.css">

<body>
<div ng-controller="AngularWayWithOptionsCtrl as showCase">
    <!-- <table datatable="ng" dt-options="showCase.dtOptions" dt-column-defs="showCase.dtColumnDefs" class="row-border hover">
        <thead>
        <tr>
            <th>ID</th>
            <th>FirstÃŸName</th>
            <th>LastName</th>
        </tr>
        </thead>
        <tbody>
        <tr ng-repeat="person in showCase.persons track by person.id">
            <td>{{ person.id }}</td>
            <td>{{ person.firstName }}</td>
            <td>{{ person.lastName }}</td>
        </tr>
        </tbody>
    </table> -->
<div>
    <input type="button" ng-click="showCase.changeData()" value="Change Data"/>
</di>
    <table class="my-dt display nowrap">
        <thead>
        <tr>
            <th></th>
            <th>ID</th>
            <th>First name</th>
            <th>Last name</th>
            <th>Age</th>
            <th>Phone</th>
            <th>Company</th>
            <th class="none"></th>
        </tr>
        </thead>
        <tbody>
        <!-- <tr>
            <td>1</td>
            <td>Foo</td>
            <td>Bar</td>
        </tr>
        <tr>
            <td>123</td>
            <td>Someone</td>
            <td>Youknow</td>
        </tr>
        <tr>
            <td>987</td>
            <td>Iamout</td>
            <td>Ofinspiration</td>
        </tr> -->
        <tr ng-repeat="person in showCase.persons track by person.id">
            <!-- <td>
                <uila-column-formatter row-data="person" 
                row-idx="$index" col-idx="0"/>
            </td> -->
            <td></td>
            <td><a href="#" ng-click="showCase.showAlert(person.id)">{{ person.id }}</a></td>
            <td>{{ person.firstName }}</td>
            <td>{{ person.lastName }}</td>
            <td>{{ person.age }}</td>
            <td>{{ person.phone }}</td>
            <td>{{ person.company }}</td>
            <td></td>
        </tr>
        </tbody>
    </table>


    <table id="products">
        <thead>
            <tr>
                <th>id</th>
                <th>name</th>
                <th>duration</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>
</body>

<script src="../../vendor/jquery/jquery-2.0.2.min.js"></script>
<script src="../../vendor/datatable/jquery.dataTables.js"></script>
<script src="../../vendor/angularjs/angular-1.4.5.js"></script>
<script src="../../vendor/angular-plugin/angular-datatables.js"></script>
<script src="../../vendor/angular-plugin/angular-resource.js"></script>
<script src="../../vendor/datatable/dataTables.responsive.js"></script>

<script>
jQuery.fn.dataTableExt.oSort['usage-asc']  = function(a, b) {
    return ((a < b) ? -1 : ((a > b) ?  1 : 0));
};
jQuery.fn.dataTableExt.oSort['usage-desc']  = function(a, b) {
    return ((b < a) ? -1 : ((b > a) ?  1 : 0));
};

jQuery.fn.dataTableExt.oSort["duration-desc"] = function (x, y) {
    function getMins(str){
        var arr = str.split(':');
        return 60 * parseInt(arr[1], 10)+ parseInt(arr[0], 10);
    };
    return getMins(x) - getMins(y);
};

jQuery.fn.dataTableExt.oSort["duration-asc"] = function (x, y) {
    return jQuery.fn.dataTableExt.oSort["duration-desc"](y, x);
}

angular.module('showcase.angularWay.withOptions', ['datatables', 'ngResource'])
.controller('AngularWayWithOptionsCtrl', AngularWayWithOptionsCtrl);

function AngularWayWithOptionsCtrl($resource, DTOptionsBuilder, DTColumnDefBuilder, $timeout) {
    var vm = this;
    vm.persons = [];

    vm.showAlert = function(id){
        alert(id);
    }
    // vm.dtOptions = DTOptionsBuilder.newOptions();
    // //.withPaginationType('full_numbers').withDisplayLength(2);
    // // //console.log(vm.dtOptions);
    // // vm.dtOptions = {
    // //     iDisplayLength: 2,
    // //     sPaginationType: "full_numbers"
    // // }
    // vm.dtColumnDefs = [
    //     DTColumnDefBuilder.newColumnDef(0),
    //     DTColumnDefBuilder.newColumnDef(1).notVisible(),
    //     DTColumnDefBuilder.newColumnDef(2).notSortable()
    // ];
    // console.log(vm.dtColumnDefs);
    // /*$resource('data.json').query().$promise.then(function(persons) {
    //     vm.persons = persons;
    // });*/
    vm.persons = [{
        "id": 860,
        "firstName": "Superman",
        "lastName": "Yoda",
        "age": 20,
        "phone": "1234334343",
        "company": "uila"
    }, {
        "id": 870,
        "firstName": "Foo",
        "lastName": "Whateveryournameis",
        "age": 108,
        "phone": "1234334343",
        "company": "uila"
    }, {
        "id": 590,
        "firstName": "Toto",
        "lastName": "Titi",
        "age": 20,
        "phone": "1234334343",
        "company": "uila"
    }];

    let ary1 = [];

    var oldtrs;

    vm.changeData = function(){

            vm.persons = [{
                "id": 860,
                "firstName": "Superman",
                "lastName": "Yoda",
                "age": 20,
                "phone": "1234334343",
                "company": "uila"
            }, {
                "id": 590,
                "firstName": "Toto",
                "lastName": "Titi",
                "age": 20,
                "phone": "1234334343",
                "company": "uila"
            }, {
                "id": 803,
                "firstName": "Luke",
                "lastName": "Kyle",
                "age": 20,
                "phone": "1234334343",
                "company": "uila"
            }, {
                "id": 476,
                "firstName": "Zed",
                "lastName": "Kyle",
                "age": 20,
                "phone": "1234334343",
                "company": "uila"
            }];

            var ary = vm.persons.map(function(d){
                return [d.id, d.firstName, d.lastName];
            });
            // console.log(ary);
            $timeout(function(){
                var dt = $(".my-dt").DataTable();
                var trs = $('.my-dt tbody').children().not(".child");
                var trsToBeRemoved = diffRows(oldtrs, trs);
                var trsToBeAdded = diffRows(trs, oldtrs);
                //debugger;
                /*dt.clear().draw();
                $timeout(function(){
                    dt.rows.add(ary).draw();
                }, 1000)*/
                var r = dt.rows(trsToBeRemoved).remove()
                        .rows.add(trsToBeAdded).draw();
                oldtrs = $('.my-dt tbody').children().not(".child");
                //r.draw();
                //dt.clear().rows.add(trs)//.draw();
            }, 0);
    }

    $timeout(function(){
        oldtrs = $('.my-dt tbody').children().not(".child");
        $(".my-dt").dataTable({
            responsive: {
                details: {
                    type: 'column'
                }
            },
            columnDefs: [ {
                className: 'control',
                orderable: false,
                targets:   0
            } ,{
                sType: 'usage',
                targets:   4
            } ],
            retrieve: true
        });

        $timeout(function(){
            addColors();
        });
    }, 0);  
 
}

// Get the rows that are not in "newTrs"
// todo: to have better name convention in params
function diffRows(oldTrs, newTrs){
    return $.grep(oldTrs, function(x) {return $.inArray(x, newTrs) < 0})
} 

function addColors() {
    var trs = $('.my-dt tbody').children().not(".child");
    var colors = ["red", "green", "yellow", "blue"];
    trs.each(function(idx, tr){
        tr.style.backgroundColor = colors[idx];
    });
}
var tableSettings = {
        "aaData": [
            [1, "Dinner", "0:40"],
            [2, "Study", "11:25"],
            [3, "Sleep", "7:30"]
        ],
        "aoColumns": [{
            "sWidth": "70%",
            "sClass": "center",
            "bSortable": false
        }, {
            "sWidth": "70%",
            "sClass": "center",
            "bSortable": false
        }, {
            "sWidth": "70%",
            "sClass": "center",
            "sType": "usage"
        }]
    
    };
$(document).ready(function(){
       var oTable = $("#products").dataTable(tableSettings);
});

</script>
</html>